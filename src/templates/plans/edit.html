{% extends "base.html" %}

{% block title %}Edit {{ plan.name }} - Fitness Club{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ url_for('plans_detail', id=plan.id) }}" class="text-blue-600 hover:text-blue-800 mr-4">
                <i class="fas fa-arrow-left text-lg"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">Edit Plan</h1>
        </div>
        <p class="text-gray-600">Update {{ plan.name }} settings and pricing</p>
    </div>

    <!-- Current Plan Impact -->
    {% if plan.member_count > 0 %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3 mt-1"></i>
            <div>
                <h3 class="text-yellow-900 font-medium">Plan Changes Impact</h3>
                <p class="text-yellow-800 text-sm mt-1">
                    This plan has {{ plan.member_count }} active members.
                    Changes to pricing or features will affect their membership.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Form Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <form method="POST" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Plan Name -->
                <div class="md:col-span-2">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                        Plan Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="name" id="name" value="{{ plan.name }}" required
                        placeholder="e.g., Premium Membership, Basic Plan"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Price -->
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                        Price <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" name="price" id="price" value="{{ plan.price }}" step="0.01" min="0"
                            required
                            class="w-full pl-7 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <p class="mt-1 text-sm text-gray-500">Current: ${{ plan.price }}</p>
                </div>

                <!-- Duration -->
                <div>
                    <label for="duration_months" class="block text-sm font-medium text-gray-700 mb-2">
                        Duration (Months) <span class="text-red-500">*</span>
                    </label>
                    <select name="duration_months" id="duration_months" required
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="1" {{ 'selected' if plan.duration_months==1 else '' }}>1 Month</option>
                        <option value="3" {{ 'selected' if plan.duration_months==3 else '' }}>3 Months</option>
                        <option value="6" {{ 'selected' if plan.duration_months==6 else '' }}>6 Months</option>
                        <option value="12" {{ 'selected' if plan.duration_months==12 else '' }}>12 Months</option>
                        <option value="24" {{ 'selected' if plan.duration_months==24 else '' }}>24 Months</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Current: {{ plan.duration_months }} months</p>
                </div>

                <!-- Description -->
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    <textarea name="description" id="description" rows="3"
                        placeholder="Describe what this plan includes..."
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ plan.description or '' }}</textarea>
                </div>

                <!-- Features -->
                <div class="md:col-span-2">
                    <label for="features" class="block text-sm font-medium text-gray-700 mb-2">
                        Features
                    </label>
                    <textarea name="features" id="features" rows="3"
                        placeholder="e.g., Access to gym, Personal trainer, Group classes (comma-separated)"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ plan.features or '' }}</textarea>
                    <p class="mt-1 text-sm text-gray-500">Enter features separated by commas</p>
                </div>
            </div>

            <!-- Current Plan Display -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Current Plan Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm font-medium text-blue-700">Price & Duration</p>
                        <p class="text-blue-900">${{ plan.price }} for {{ plan.duration_months }} months</p>
                        <p class="text-sm text-blue-700">${{ "%.2f"|format(plan.price / plan.duration_months) }}/month
                        </p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-700">Active Members</p>
                        <p class="text-blue-900">{{ plan.member_count }} members</p>
                        <p class="text-sm text-blue-700">${{ "%.0f"|format(plan.price * plan.member_count) }}/month
                            revenue</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-700">Features Count</p>
                        <p class="text-blue-900">{{ plan.features.split(',')|length if plan.features else 0 }} features
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('plans_detail', id=plan.id) }}"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    Update Plan
                </button>
            </div>
        </form>
    </div>

    <!-- Plan Preview -->
    <div id="planPreview" class="mt-8 bg-blue-50 rounded-lg p-6 hidden">
        <h3 class="text-lg font-semibold text-blue-900 mb-4">Updated Plan Preview</h3>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-blue-200">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 id="previewName" class="text-xl font-bold text-gray-900">{{ plan.name }}</h4>
                    <p id="previewDescription" class="text-gray-600">{{ plan.description or 'Plan description' }}</p>
                </div>
                <div class="text-right">
                    <p id="previewPrice" class="text-2xl font-bold text-blue-600">${{ plan.price }}</p>
                    <p id="previewDuration" class="text-sm text-gray-500">{{ plan.duration_months }} months</p>
                    <p id="previewMonthly" class="text-xs text-gray-500">${{ "%.2f"|format(plan.price /
                        plan.duration_months) }}/month</p>
                </div>
            </div>
            <div id="previewFeatures" class="{{ 'hidden' if not plan.features else '' }}">
                <h5 class="font-medium text-gray-900 mb-2">Features:</h5>
                <div id="featuresContainer" class="flex flex-wrap gap-2">
                    {% if plan.features %}
                    {% for feature in plan.features.split(',') %}
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{
                        feature.strip() }}</span>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Impact Analysis -->
    {% if plan.member_count > 0 %}
    <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Change Impact Analysis</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <i class="fas fa-users text-blue-600 text-2xl mb-2"></i>
                <p class="text-sm text-blue-700">Affected Members</p>
                <p class="text-xl font-bold text-blue-900">{{ plan.member_count }}</p>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <i class="fas fa-dollar-sign text-green-600 text-2xl mb-2"></i>
                <p class="text-sm text-green-700">Current Revenue</p>
                <p class="text-xl font-bold text-green-900">${{ "%.0f"|format(plan.price * plan.member_count) }}</p>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
                <i class="fas fa-chart-line text-purple-600 text-2xl mb-2"></i>
                <p class="text-sm text-purple-700">Monthly Rate</p>
                <p class="text-xl font-bold text-purple-900">${{ "%.2f"|format(plan.price / plan.duration_months) }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Danger Zone -->
    <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-red-900 mb-4">Danger Zone</h3>
        <p class="text-red-700 mb-4">
            Be careful when making significant changes to plans with active members.
            Consider creating a new plan instead of modifying this one if the changes are substantial.
        </p>
        <div class="flex space-x-4">
            <button onclick="showPriceImpact()"
                class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                <i class="fas fa-calculator mr-2"></i>
                Calculate Price Impact
            </button>
            {% if plan.member_count == 0 %}
            <button onclick="confirmPlanDeletion()"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-trash mr-2"></i>
                Delete Plan
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- JavaScript for Plan Preview and Impact Calculation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const nameInput = document.getElementById('name');
        const priceInput = document.getElementById('price');
        const durationSelect = document.getElementById('duration_months');
        const descriptionInput = document.getElementById('description');
        const featuresInput = document.getElementById('features');

        const planPreview = document.getElementById('planPreview');
        const previewName = document.getElementById('previewName');
        const previewPrice = document.getElementById('previewPrice');
        const previewDuration = document.getElementById('previewDuration');
        const previewMonthly = document.getElementById('previewMonthly');
        const previewDescription = document.getElementById('previewDescription');
        const previewFeatures = document.getElementById('previewFeatures');
        const featuresContainer = document.getElementById('featuresContainer');

        const originalValues = {
            name: '{{ plan.name }}',
            price: {{ plan.price }
    },
        duration: {{ plan.duration_months }},
        description: '{{ plan.description or "" }}',
        features: '{{ plan.features or "" }}'
    };

    function updatePreview() {
        const name = nameInput.value.trim();
        const price = parseFloat(priceInput.value) || 0;
        const duration = parseInt(durationSelect.value) || 1;
        const description = descriptionInput.value.trim();
        const features = featuresInput.value.trim();

        const hasChanges = name !== originalValues.name ||
            price !== originalValues.price ||
            duration !== originalValues.duration ||
            description !== originalValues.description ||
            features !== originalValues.features;

        if (hasChanges) {
            previewName.textContent = name || 'Plan Name';
            previewPrice.textContent = `$${price.toFixed(2)}`;
            previewDuration.textContent = `${duration} months`;
            previewMonthly.textContent = `$${(price / duration).toFixed(2)}/month`;
            previewDescription.textContent = description || 'Plan description';

            // Update features
            if (features) {
                const featuresList = features.split(',').map(f => f.trim()).filter(f => f);
                featuresContainer.innerHTML = featuresList.map(feature =>
                    `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${feature}</span>`
                ).join('');
                previewFeatures.classList.remove('hidden');
            } else {
                previewFeatures.classList.add('hidden');
            }

            planPreview.classList.remove('hidden');
        } else {
            planPreview.classList.add('hidden');
        }
    }

    // Add event listeners
    [nameInput, priceInput, durationSelect, descriptionInput, featuresInput].forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
    });

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function (e) {
        const name = nameInput.value.trim();
        const price = priceInput.value.trim();
        const duration = durationSelect.value;

        if (!name || !price || !duration) {
            e.preventDefault();
            alert('Please fill in all required fields (Name, Price, and Duration).');
            return;
        }

        if (parseFloat(price) < 0) {
            e.preventDefault();
            alert('Price must be a positive number.');
            return;
        }
    });
});

    function showPriceImpact() {
        const currentPrice = {{ plan.price }
    };
    const newPrice = parseFloat(document.getElementById('price').value) || currentPrice;
    const memberCount = {{ plan.member_count }};

    const currentRevenue = currentPrice * memberCount;
    const newRevenue = newPrice * memberCount;
    const difference = newRevenue - currentRevenue;

    const message = `Price Impact Analysis:
    
Current Revenue: $${currentRevenue.toFixed(2)}/month
New Revenue: $${newRevenue.toFixed(2)}/month
Difference: ${difference >= 0 ? '+' : ''}$${difference.toFixed(2)}/month

This affects ${memberCount} members.`;

    alert(message);
}

    function confirmPlanDeletion() {
        if (confirm('Are you sure you want to delete this plan? This action cannot be undone.')) {
            alert('Plan deletion functionality will be implemented in Sprint 3.');
        }
    }
</script>
{% endblock %}