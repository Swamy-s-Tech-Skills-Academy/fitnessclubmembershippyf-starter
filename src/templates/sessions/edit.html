{% extends "base.html" %}

{% block title %}Edit {{ session.title }} - Fitness Club{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ url_for('sessions_detail', id=session.id) }}"
                class="text-gray-600 hover:text-blue-600 transition-colors mr-4">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Edit Session</h1>
                <p class="text-gray-600 mt-2">Update {{ session.title }}'s details and schedule</p>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Session Details</h3>
            <p class="text-sm text-gray-600 mt-1">Update the session information and schedule</p>
        </div>

        <form method="POST" class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Session Information -->
                <div class="space-y-6">
                    <h4 class="text-md font-medium text-gray-900 border-b border-gray-200 pb-2">Session Information</h4>

                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            Session Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="title" id="title" required value="{{ session.title }}"
                            placeholder="e.g., Morning Yoga, HIIT Training"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="trainer_id" class="block text-sm font-medium text-gray-700 mb-2">
                            Trainer <span class="text-red-500">*</span>
                        </label>
                        <select name="trainer_id" id="trainer_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select a trainer</option>
                            {% for trainer in trainers %}
                            <option value="{{ trainer.id }}" {{ 'selected' if trainer.id==session.trainer_id else '' }}>
                                {{ trainer.name }}
                                {% if trainer.specialization %}
                                - {{ trainer.specialization }}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
                            Location
                        </label>
                        <input type="text" name="location" id="location" value="{{ session.location or '' }}"
                            placeholder="e.g., Studio A, Gym Floor, Outdoor Area"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                            Status
                        </label>
                        <select name="status" id="status"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="scheduled" {{ 'selected' if session.status=='scheduled' else '' }}>Scheduled
                            </option>
                            <option value="in_progress" {{ 'selected' if session.status=='in_progress' else '' }}>In
                                Progress</option>
                            <option value="completed" {{ 'selected' if session.status=='completed' else '' }}>Completed
                            </option>
                            <option value="cancelled" {{ 'selected' if session.status=='cancelled' else '' }}>Cancelled
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Schedule & Pricing -->
                <div class="space-y-6">
                    <h4 class="text-md font-medium text-gray-900 border-b border-gray-200 pb-2">Schedule & Pricing</h4>

                    <div>
                        <label for="start_time" class="block text-sm font-medium text-gray-700 mb-2">
                            Start Date & Time <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" name="start_time" id="start_time" required
                            value="{{ session.start_time.strftime('%Y-%m-%dT%H:%M') if session.start_time else '' }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="end_time" class="block text-sm font-medium text-gray-700 mb-2">
                            End Date & Time <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" name="end_time" id="end_time" required
                            value="{{ session.end_time.strftime('%Y-%m-%dT%H:%M') if session.end_time else '' }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="capacity" class="block text-sm font-medium text-gray-700 mb-2">
                            Maximum Capacity
                        </label>
                        <input type="number" name="capacity" id="capacity" min="1" max="100"
                            value="{{ session.capacity or 10 }}" placeholder="10"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-sm text-gray-500 mt-1">Maximum number of participants</p>
                    </div>

                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                            Session Price
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500">$</span>
                            <input type="number" name="price" id="price" min="0" step="0.01"
                                value="{{ session.price or 0 }}" placeholder="0.00"
                                class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Cost per participant</p>
                    </div>
                </div>
            </div>

            <!-- Description Section -->
            <div class="mt-8">
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Session Description
                </label>
                <textarea name="description" id="description" rows="4"
                    placeholder="Describe the session content, goals, and what participants can expect..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ session.description or '' }}</textarea>
                <p class="text-sm text-gray-500 mt-1">This will help participants understand what to expect</p>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                <a href="{{ url_for('sessions_detail', id=session.id) }}"
                    class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    Update Session
                </button>
            </div>
        </form>
    </div>

    <!-- Warnings Section -->
    <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
            <div>
                <h4 class="text-md font-medium text-yellow-900 mb-2">Session Update Warnings</h4>
                <ul class="text-sm text-yellow-800 space-y-1">
                    <li>• Changing the trainer may affect session continuity and participant expectations</li>
                    <li>• Time changes should be communicated to registered participants in advance</li>
                    <li>• Reducing capacity may affect already registered participants</li>
                    <li>• Status changes to "cancelled" or "completed" may be irreversible</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Danger Zone -->
    {% if session.status in ['scheduled', 'in_progress'] %}
    <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
        <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3"></i>
            <div>
                <h4 class="text-md font-medium text-red-900 mb-2">Danger Zone</h4>
                <p class="text-sm text-red-800 mb-4">
                    This session is currently {{ session.status.replace('_', ' ') }}.
                    Making changes may impact participants and operations.
                </p>

                {% if session.status == 'in_progress' %}
                <div class="text-sm text-red-800">
                    <strong>Warning:</strong> This session is currently in progress.
                    Changes to time, location, or trainer should be avoided.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Form validation
    document.querySelector('form').addEventListener('submit', function (e) {
        const name = document.getElementById('name').value.trim();
        const trainerId = document.getElementById('trainer_id').value;
        const startTime = document.getElementById('start_time').value;
        const endTime = document.getElementById('end_time').value;

        if (!name) {
            e.preventDefault();
            alert('Please enter a session name');
            document.getElementById('name').focus();
            return;
        }

        if (!trainerId) {
            e.preventDefault();
            alert('Please select a trainer');
            document.getElementById('trainer_id').focus();
            return;
        }

        if (!startTime || !endTime) {
            e.preventDefault();
            alert('Please set both start and end times');
            return;
        }

        // Validate that end time is after start time
        if (new Date(endTime) <= new Date(startTime)) {
            e.preventDefault();
            alert('End time must be after start time');
            document.getElementById('end_time').focus();
            return;
        }
    });

    // Real-time validation for times
    document.getElementById('end_time').addEventListener('change', function () {
        const startTime = document.getElementById('start_time').value;
        const endTime = this.value;

        if (startTime && endTime) {
            if (new Date(endTime) <= new Date(startTime)) {
                this.classList.add('border-red-500');
                this.classList.remove('border-gray-300');
            } else {
                this.classList.remove('border-red-500');
                this.classList.add('border-gray-300');
            }
        }
    });

    // Confirm status changes
    document.getElementById('status').addEventListener('change', function () {
        const originalStatus = '{{ session.status }}';
        const newStatus = this.value;

        if (originalStatus !== newStatus) {
            if (newStatus === 'cancelled') {
                if (!confirm('Are you sure you want to cancel this session? This may affect registered participants.')) {
                    this.value = originalStatus;
                    return;
                }
            }

            if (newStatus === 'completed' && originalStatus !== 'in_progress') {
                if (!confirm('Mark this session as completed? This action may be irreversible.')) {
                    this.value = originalStatus;
                    return;
                }
            }
        }
    });

    // Confirm trainer changes
    document.getElementById('trainer_id').addEventListener('change', function () {
        const originalTrainer = '{{ session.trainer_id }}';
        const newTrainer = this.value;

        if (originalTrainer !== newTrainer && originalTrainer) {
            if (!confirm('Changing the trainer may affect session continuity. Continue?')) {
                this.value = originalTrainer;
            }
        }
    });
</script>
{% endblock %}